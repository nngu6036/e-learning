"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var log_model_1 = require("../models/elearning/log.model");
var _ = require("underscore");
var moment = require("moment");
var constants_1 = require("../models/constants");
var achievement_model_1 = require("../models/elearning/achievement.model");
var StatsUtils = (function () {
    function StatsUtils() {
    }
    StatsUtils.prototype.competencyStatistic = function (context, competency, levels) {
        return achievement_model_1.Achivement.listByCompetency(context, competency.id).map(function (skills) {
            var skillsByGroup = _.groupBy(skills, 'user_id');
            var profile = {};
            _.each(levels, function (level) {
                profile[level.id] = 0;
            });
            _.each(skillsByGroup, function (skillList) {
                var skill = _.max(skillList, function (obj) {
                    return obj.date_acquire.getTime();
                });
                profile[skill.competency_level_id] += 1;
            });
            return profile;
        });
    };
    StatsUtils.prototype.competencyStatisticByDate = function (context, competency, levels, startDate, endDate) {
        var startDateStr = moment(startDate).format(constants_1.SERVER_DATETIME_FORMAT);
        var endDateStr = moment(endDate).format(constants_1.SERVER_DATETIME_FORMAT);
        return achievement_model_1.Achivement.searchByDateAndCompetency(context, competency.id, startDate, endDate).map(function (skills) {
            var monthLengthMills = 1000 * 60 * 60 * 24 * 30;
            var slots = [];
            var starTimeMillis = startDate.getTime();
            var endTimeMills = endDate.getTime();
            for (var i = 0; starTimeMillis + i * monthLengthMills < endTimeMills; i++)
                slots.push(0);
            var skillsByGroup = _.groupBy(skills, 'user_id');
            _.each(skillsByGroup, function (skillList) {
                var skill = _.max(skillList, function (obj) {
                    return obj.date_acquire.getTime();
                });
                var dateAcquire = new Date(skill.date_acquire);
                var index = Math.floor((dateAcquire.getTime() - starTimeMillis) / monthLengthMills);
                var profile = slots[index];
                if (!profile) {
                    profile = {};
                    _.each(levels, function (level) {
                        profile[level.id] = 0;
                    });
                }
                profile[skill.competency_level_id] += 1;
                slots[index] = profile;
            });
            return slots;
        });
    };
    StatsUtils.prototype.courseStatisticByDate = function (context, startDate, endDate) {
        var startDateStr = moment(startDate).format(constants_1.SERVER_DATETIME_FORMAT);
        var endDateStr = moment(endDate).format(constants_1.SERVER_DATETIME_FORMAT);
        return log_model_1.CourseLog.search(context, [], "[('start','>=','" + startDateStr + "'),('start','<=','" + endDateStr + "'),('res_model','=','etraining.course')]").map(function (logs) {
            var dayLengthMills = 1000 * 60 * 60 * 24;
            var slots = [];
            var starTimeMillis = startDate.getTime();
            var endTimeMills = endDate.getTime();
            for (var i = 0; starTimeMillis + i * dayLengthMills < endTimeMills; i++)
                slots.push(0);
            _.each(logs, function (log) {
                var start = new Date(log.start);
                var index = Math.floor((start.getTime() - starTimeMillis) / dayLengthMills);
                slots[index]++;
            });
            return slots;
        });
    };
    StatsUtils.prototype.courseMemberStatisticByDate = function (context, memberId, courseId, startDate, endDate) {
        var startDateStr = moment(startDate).format(constants_1.SERVER_DATETIME_FORMAT);
        var endDateStr = moment(endDate).format(constants_1.SERVER_DATETIME_FORMAT);
        return log_model_1.CourseLog.search(context, [], "[('member_id','='," + memberId + "),('course_id','='," + courseId + "),('start','>=','" + startDateStr + "'),('start','<=','" + endDateStr + "'),('res_model','=','etraining.course')]").map(function (logs) {
            var dayLengthMills = 1000 * 60 * 60 * 24;
            var slots = [];
            var starTimeMillis = startDate.getTime();
            var endTimeMills = endDate.getTime();
            for (var i = 0; starTimeMillis + i * dayLengthMills < endTimeMills; i++)
                slots.push(0);
            _.each(logs, function (log) {
                var start = new Date(log.start);
                var index = Math.floor((start.getTime() - starTimeMillis) / dayLengthMills);
                slots[index]++;
            });
            return slots;
        });
    };
    StatsUtils.prototype.examAnswerStatistics = function (answers) {
        var multichoiceAnswer = _.filter(answers, function (ans) {
            return ans["question_type"] == 'sc' || ans["question_type"] == 'mc';
        });
        var ratingAnswer = _.filter(answers, function (ans) {
            return ans["question_type"] == 'rate';
        });
        var openAnswer = _.filter(answers, function (ans) {
            return ans["question_type"] == 'ext';
        });
        return {
            'multichoice': this.multichoiceAnswerStatistics(answers),
            'rating': this.ratingAnswerStatistics(answers),
            'open': this.openAnswerStatistics(answers)
        };
    };
    StatsUtils.prototype.surveyAnswerStatistics = function (answers) {
        var multichoiceAnswer = _.filter(answers, function (ans) {
            return ans["question_type"] == 'sc' || ans["question_type"] == 'mc';
        });
        var ratingAnswer = _.filter(answers, function (ans) {
            return ans["question_type"] == 'rate';
        });
        var openAnswer = _.filter(answers, function (ans) {
            return ans["question_type"] == 'ext';
        });
        return {
            'multichoice': this.multichoiceAnswerStatistics(answers),
            'rating': this.ratingAnswerStatistics(answers),
            'open': this.openAnswerStatistics(answers)
        };
    };
    StatsUtils.prototype.openAnswerStatistics = function (answers) {
        var questionAttempts = {};
        _.each(answers, function (ans) {
            if (!questionAttempts[ans["question_id"]])
                questionAttempts[ans["question_id"]] = [];
            questionAttempts[ans["question_id"]].push(ans.text);
        });
    };
    StatsUtils.prototype.ratingAnswerStatistics = function (answers) {
        var ratingPercentage = {};
        var questionAttempts = {};
        _.each(answers, function (ans) {
            if (!questionAttempts[ans["question_id"]])
                questionAttempts[ans["question_id"]] = 1;
            else
                questionAttempts[ans["question_id"]]++;
            if (!ratingPercentage[ans["question_id"]])
                ratingPercentage[ans["question_id"]] = 0;
            else
                ratingPercentage[ans["question_id"]]++;
            if (ans.text)
                ratingPercentage[ans["question_id"]] += +ans.text;
        });
        return _.map(ratingPercentage, function (rate, id) {
            return ratingPercentage[id] / questionAttempts[id];
        });
    };
    StatsUtils.prototype.multichoiceAnswerStatistics = function (answers) {
        var option2Question = {};
        var optionIds = [];
        var optionAttempts = {};
        var questionAttempts = {};
        _.each(answers, function (ans) {
            var selectedOptionIds = [];
            if (ans.option_id)
                selectedOptionIds.push(ans.option_id);
            else if (ans.json)
                selectedOptionIds = JSON.parse(ans.json);
            optionIds = optionIds.concat(selectedOptionIds);
            _.each(selectedOptionIds, function (id) {
                option2Question[id] = ans["question_id"];
                if (!optionAttempts[id])
                    optionAttempts[id] = 1;
                else
                    optionAttempts[id]++;
            });
            if (!questionAttempts[ans["question_id"]])
                questionAttempts[ans["question_id"]] = 1;
            else
                questionAttempts[ans["question_id"]]++;
        });
        optionIds = _.uniq(optionIds);
        var optionPercentage = {};
        _.each(optionIds, function (optionId) {
            var questionId = option2Question[optionId];
            var questionAttempt = questionAttempts[questionId];
            var optionAttempt = optionAttempts[optionId];
            if (questionAttempt)
                optionPercentage[optionId] = optionAttempt * 100 / questionAttempt;
            else
                optionPercentage[optionId] = 0;
        });
        return optionPercentage;
    };
    StatsUtils.prototype.userLoginStatisticByDate = function (context, startDate, endDate) {
        var startDateStr = moment(startDate).format(constants_1.SERVER_DATETIME_FORMAT);
        var endDateStr = moment(endDate).format(constants_1.SERVER_DATETIME_FORMAT);
        return log_model_1.UserLog.search(context, [], "[('start','>=','" + startDateStr + "'),('start','<=','" + endDateStr + "'),('res_model','=','res.users'),('code','=','LOGIN')]").map(function (logs) {
            var dayLengthMills = 1000 * 60 * 60 * 24;
            var slots = [];
            var starTimeMillis = startDate.getTime();
            var endTimeMills = endDate.getTime();
            for (var i = 0; starTimeMillis + i * dayLengthMills < endTimeMills; i++)
                slots.push(0);
            _.each(logs, function (log) {
                var start = new Date(log.start);
                var index = Math.floor((start.getTime() - starTimeMillis) / dayLengthMills);
                slots[index]++;
            });
            return slots;
        });
    };
    return StatsUtils;
}());
exports.StatsUtils = StatsUtils;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC9zaGFyZWQvaGVscGVycy9zdGF0aXN0aWNzLnV0aWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBR0EsMkRBQTRFO0FBQzVFLDhCQUFnQztBQUNoQywrQkFBaUM7QUFDakMsaURBQTZEO0FBTzdELDJFQUFtRTtBQUduRTtJQUVDO0lBQ0EsQ0FBQztJQUVELHdDQUFtQixHQUFuQixVQUFvQixPQUFtQixFQUFFLFVBQXNCLEVBQUUsTUFBeUI7UUFDekYsT0FBTyw4QkFBVSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sRUFBRSxVQUFVLENBQUMsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLFVBQUEsTUFBTTtZQUNwRSxJQUFJLGFBQWEsR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxTQUFTLENBQUMsQ0FBQztZQUNqRCxJQUFJLE9BQU8sR0FBRyxFQUFFLENBQUM7WUFDakIsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsVUFBQyxLQUFzQjtnQkFDckMsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDdkIsQ0FBQyxDQUFDLENBQUM7WUFDSCxDQUFDLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxVQUFBLFNBQVM7Z0JBQzlCLElBQUksS0FBSyxHQUFlLENBQUMsQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLFVBQUMsR0FBZTtvQkFDeEQsT0FBTyxHQUFHLENBQUMsWUFBWSxDQUFDLE9BQU8sRUFBRSxDQUFDO2dCQUNuQyxDQUFDLENBQUMsQ0FBQztnQkFDSCxPQUFPLENBQUMsS0FBSyxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3pDLENBQUMsQ0FBQyxDQUFBO1lBQ0YsT0FBTyxPQUFPLENBQUM7UUFDaEIsQ0FBQyxDQUFDLENBQUM7SUFDSixDQUFDO0lBRUQsOENBQXlCLEdBQXpCLFVBQTBCLE9BQW1CLEVBQUUsVUFBc0IsRUFBRSxNQUF5QixFQUFFLFNBQWUsRUFBRSxPQUFhO1FBQy9ILElBQUksWUFBWSxHQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxNQUFNLENBQUMsa0NBQXNCLENBQUMsQ0FBQztRQUNwRSxJQUFJLFVBQVUsR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxDQUFDLGtDQUFzQixDQUFDLENBQUM7UUFDaEUsT0FBTyw4QkFBVSxDQUFDLHlCQUF5QixDQUFDLE9BQU8sRUFBRSxVQUFVLENBQUMsRUFBRSxFQUFFLFNBQVMsRUFBRSxPQUFPLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBQSxNQUFNO1lBQ2pHLElBQUksZ0JBQWdCLEdBQUcsSUFBSSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsQ0FBQztZQUNoRCxJQUFJLEtBQUssR0FBRyxFQUFFLENBQUM7WUFDZixJQUFJLGNBQWMsR0FBRyxTQUFTLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDekMsSUFBSSxZQUFZLEdBQUcsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ3JDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLGNBQWMsR0FBRyxDQUFDLEdBQUcsZ0JBQWdCLEdBQUcsWUFBWSxFQUFFLENBQUMsRUFBRTtnQkFDeEUsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNmLElBQUksYUFBYSxHQUFHLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1lBQ2pELENBQUMsQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLFVBQUMsU0FBdUI7Z0JBQzdDLElBQUksS0FBSyxHQUFlLENBQUMsQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLFVBQUMsR0FBZTtvQkFDeEQsT0FBTyxHQUFHLENBQUMsWUFBWSxDQUFDLE9BQU8sRUFBRSxDQUFDO2dCQUNuQyxDQUFDLENBQUMsQ0FBQztnQkFDSCxJQUFJLFdBQVcsR0FBRyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLENBQUM7Z0JBQy9DLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLEdBQUcsY0FBYyxDQUFDLEdBQUcsZ0JBQWdCLENBQUMsQ0FBQztnQkFDcEYsSUFBSSxPQUFPLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUMzQixJQUFJLENBQUMsT0FBTyxFQUFFO29CQUNiLE9BQU8sR0FBRyxFQUFFLENBQUM7b0JBQ2IsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsVUFBQyxLQUFzQjt3QkFDckMsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLENBQUM7b0JBQ3ZCLENBQUMsQ0FBQyxDQUFBO2lCQUNGO2dCQUNELE9BQU8sQ0FBQyxLQUFLLENBQUMsbUJBQW1CLENBQUMsSUFBRyxDQUFDLENBQUM7Z0JBQ3ZDLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxPQUFPLENBQUM7WUFDeEIsQ0FBQyxDQUFDLENBQUM7WUFDSCxPQUFPLEtBQUssQ0FBQztRQUNkLENBQUMsQ0FBQyxDQUFDO0lBQ0osQ0FBQztJQUVELDBDQUFxQixHQUFyQixVQUFzQixPQUFtQixFQUFFLFNBQWUsRUFBRSxPQUFhO1FBQ3hFLElBQUksWUFBWSxHQUFHLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxNQUFNLENBQUMsa0NBQXNCLENBQUMsQ0FBQztRQUNwRSxJQUFJLFVBQVUsR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUMsTUFBTSxDQUFDLGtDQUFzQixDQUFDLENBQUM7UUFDaEUsT0FBTyxxQkFBUyxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsRUFBRSxFQUFFLGtCQUFrQixHQUFHLFlBQVksR0FBRyxvQkFBb0IsR0FBRyxVQUFVLEdBQUcsMENBQTBDLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBQSxJQUFJO1lBQ2hLLElBQUksY0FBYyxHQUFHLElBQUksR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsQ0FBQztZQUN6QyxJQUFJLEtBQUssR0FBRyxFQUFFLENBQUM7WUFDZixJQUFJLGNBQWMsR0FBRyxTQUFTLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDekMsSUFBSSxZQUFZLEdBQUcsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ3JDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLGNBQWMsR0FBRyxDQUFDLEdBQUcsY0FBYyxHQUFHLFlBQVksRUFBRSxDQUFDLEVBQUU7Z0JBQ3RFLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDZixDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxVQUFDLEdBQWM7Z0JBQzNCLElBQUksS0FBSyxHQUFHLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDaEMsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsR0FBRyxjQUFjLENBQUMsR0FBRyxjQUFjLENBQUMsQ0FBQztnQkFDNUUsS0FBSyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDaEIsQ0FBQyxDQUFDLENBQUM7WUFDSCxPQUFPLEtBQUssQ0FBQztRQUNkLENBQUMsQ0FBQyxDQUFDO0lBQ0osQ0FBQztJQUVELGdEQUEyQixHQUEzQixVQUE0QixPQUFtQixFQUFFLFFBQWdCLEVBQUUsUUFBZ0IsRUFBRSxTQUFlLEVBQUUsT0FBYTtRQUNsSCxJQUFJLFlBQVksR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsTUFBTSxDQUFDLGtDQUFzQixDQUFDLENBQUM7UUFDcEUsSUFBSSxVQUFVLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxrQ0FBc0IsQ0FBQyxDQUFDO1FBQ2hFLE9BQU8scUJBQVMsQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLEVBQUUsRUFBRSxvQkFBb0IsR0FBRyxRQUFRLEdBQUcscUJBQXFCLEdBQUcsUUFBUSxHQUFHLG1CQUFtQixHQUFHLFlBQVksR0FBRyxvQkFBb0IsR0FBRyxVQUFVLEdBQUcsMENBQTBDLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBQSxJQUFJO1lBQ3RPLElBQUksY0FBYyxHQUFHLElBQUksR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsQ0FBQztZQUN6QyxJQUFJLEtBQUssR0FBRyxFQUFFLENBQUM7WUFDZixJQUFJLGNBQWMsR0FBRyxTQUFTLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDekMsSUFBSSxZQUFZLEdBQUcsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ3JDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLGNBQWMsR0FBRyxDQUFDLEdBQUcsY0FBYyxHQUFHLFlBQVksRUFBRSxDQUFDLEVBQUU7Z0JBQ3RFLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDZixDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxVQUFDLEdBQWM7Z0JBQzNCLElBQUksS0FBSyxHQUFHLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFDaEMsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsR0FBRyxjQUFjLENBQUMsR0FBRyxjQUFjLENBQUMsQ0FBQztnQkFDNUUsS0FBSyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDaEIsQ0FBQyxDQUFDLENBQUM7WUFDSCxPQUFPLEtBQUssQ0FBQztRQUNkLENBQUMsQ0FBQyxDQUFDO0lBQ0osQ0FBQztJQUVELHlDQUFvQixHQUFwQixVQUFxQixPQUFjO1FBQ2xDLElBQUksaUJBQWlCLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsVUFBQSxHQUFHO1lBQzVDLE9BQU8sR0FBRyxDQUFDLGVBQWUsQ0FBQyxJQUFJLElBQUksSUFBSSxHQUFHLENBQUMsZUFBZSxDQUFDLElBQUksSUFBSSxDQUFDO1FBQ3JFLENBQUMsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxZQUFZLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsVUFBQSxHQUFHO1lBQ3ZDLE9BQU8sR0FBRyxDQUFDLGVBQWUsQ0FBQyxJQUFJLE1BQU0sQ0FBQztRQUN2QyxDQUFDLENBQUMsQ0FBQztRQUNILElBQUksVUFBVSxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLFVBQUEsR0FBRztZQUNyQyxPQUFPLEdBQUcsQ0FBQyxlQUFlLENBQUMsSUFBSSxLQUFLLENBQUM7UUFDdEMsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPO1lBQ04sYUFBYSxFQUFFLElBQUksQ0FBQywyQkFBMkIsQ0FBQyxPQUFPLENBQUM7WUFDeEQsUUFBUSxFQUFFLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxPQUFPLENBQUM7WUFDOUMsTUFBTSxFQUFFLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxPQUFPLENBQUM7U0FDMUMsQ0FBQTtJQUNGLENBQUM7SUFFRCwyQ0FBc0IsR0FBdEIsVUFBdUIsT0FBYztRQUNwQyxJQUFJLGlCQUFpQixHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLFVBQUEsR0FBRztZQUM1QyxPQUFPLEdBQUcsQ0FBQyxlQUFlLENBQUMsSUFBSSxJQUFJLElBQUksR0FBRyxDQUFDLGVBQWUsQ0FBQyxJQUFJLElBQUksQ0FBQztRQUNyRSxDQUFDLENBQUMsQ0FBQztRQUNILElBQUksWUFBWSxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLFVBQUEsR0FBRztZQUN2QyxPQUFPLEdBQUcsQ0FBQyxlQUFlLENBQUMsSUFBSSxNQUFNLENBQUM7UUFDdkMsQ0FBQyxDQUFDLENBQUM7UUFDSCxJQUFJLFVBQVUsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxVQUFBLEdBQUc7WUFDckMsT0FBTyxHQUFHLENBQUMsZUFBZSxDQUFDLElBQUksS0FBSyxDQUFDO1FBQ3RDLENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTztZQUNOLGFBQWEsRUFBRSxJQUFJLENBQUMsMkJBQTJCLENBQUMsT0FBTyxDQUFDO1lBQ3hELFFBQVEsRUFBRSxJQUFJLENBQUMsc0JBQXNCLENBQUMsT0FBTyxDQUFDO1lBQzlDLE1BQU0sRUFBRSxJQUFJLENBQUMsb0JBQW9CLENBQUMsT0FBTyxDQUFDO1NBQzFDLENBQUE7SUFDRixDQUFDO0lBRUQseUNBQW9CLEdBQXBCLFVBQXFCLE9BQWM7UUFDbEMsSUFBSSxnQkFBZ0IsR0FBRyxFQUFFLENBQUM7UUFDMUIsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsVUFBQSxHQUFHO1lBQ2xCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUM7Z0JBQ3hDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUMzQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3JELENBQUMsQ0FBQyxDQUFDO0lBQ0osQ0FBQztJQUVELDJDQUFzQixHQUF0QixVQUF1QixPQUFjO1FBQ3BDLElBQUksZ0JBQWdCLEdBQUcsRUFBRSxDQUFDO1FBQzFCLElBQUksZ0JBQWdCLEdBQUcsRUFBRSxDQUFDO1FBQzFCLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLFVBQUEsR0FBRztZQUNsQixJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFDO2dCQUN4QyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7O2dCQUV6QyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUMsRUFBRSxDQUFDO1lBQ3hDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUM7Z0JBQ3hDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQzs7Z0JBRXpDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQyxFQUFFLENBQUM7WUFDeEMsSUFBSSxHQUFHLENBQUMsSUFBSTtnQkFDWCxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUM7UUFDcEQsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPLENBQUMsQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLEVBQUUsVUFBQyxJQUFJLEVBQUUsRUFBRTtZQUN2QyxPQUFPLGdCQUFnQixDQUFDLEVBQUUsQ0FBQyxHQUFHLGdCQUFnQixDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3BELENBQUMsQ0FBQyxDQUFDO0lBQ0osQ0FBQztJQUVELGdEQUEyQixHQUEzQixVQUE0QixPQUFjO1FBQ3pDLElBQUksZUFBZSxHQUFHLEVBQUUsQ0FBQztRQUN6QixJQUFJLFNBQVMsR0FBRyxFQUFFLENBQUM7UUFDbkIsSUFBSSxjQUFjLEdBQUcsRUFBRSxDQUFDO1FBQ3hCLElBQUksZ0JBQWdCLEdBQUcsRUFBRSxDQUFDO1FBQzFCLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLFVBQUMsR0FBVztZQUMzQixJQUFJLGlCQUFpQixHQUFHLEVBQUUsQ0FBQztZQUMzQixJQUFJLEdBQUcsQ0FBQyxTQUFTO2dCQUNoQixpQkFBaUIsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO2lCQUNsQyxJQUFJLEdBQUcsQ0FBQyxJQUFJO2dCQUNoQixpQkFBaUIsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUMxQyxTQUFTLEdBQUcsU0FBUyxDQUFDLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDO1lBQ2hELENBQUMsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLEVBQUUsVUFBQSxFQUFFO2dCQUMzQixlQUFlLENBQUMsRUFBRSxDQUFDLEdBQUcsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFDO2dCQUN6QyxJQUFJLENBQUMsY0FBYyxDQUFDLEVBQUUsQ0FBQztvQkFDdEIsY0FBYyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQzs7b0JBRXZCLGNBQWMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDO1lBQ3ZCLENBQUMsQ0FBQyxDQUFDO1lBQ0gsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQztnQkFDeEMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDOztnQkFFekMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLGFBQWEsQ0FBQyxDQUFDLEVBQUUsQ0FBQztRQUN6QyxDQUFDLENBQUMsQ0FBQztRQUNILFNBQVMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQzlCLElBQUksZ0JBQWdCLEdBQUcsRUFBRSxDQUFDO1FBQzFCLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLFVBQUEsUUFBUTtZQUN6QixJQUFJLFVBQVUsR0FBRyxlQUFlLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDM0MsSUFBSSxlQUFlLEdBQUcsZ0JBQWdCLENBQUMsVUFBVSxDQUFDLENBQUM7WUFDbkQsSUFBSSxhQUFhLEdBQUcsY0FBYyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1lBQzdDLElBQUksZUFBZTtnQkFDbEIsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLEdBQUcsYUFBYSxHQUFHLEdBQUcsR0FBRyxlQUFlLENBQUM7O2dCQUVuRSxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFakMsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPLGdCQUFnQixDQUFDO0lBQ3pCLENBQUM7SUFFRCw2Q0FBd0IsR0FBeEIsVUFBeUIsT0FBbUIsRUFBRSxTQUFlLEVBQUUsT0FBYTtRQUMzRSxJQUFJLFlBQVksR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUMsTUFBTSxDQUFDLGtDQUFzQixDQUFDLENBQUM7UUFDcEUsSUFBSSxVQUFVLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLE1BQU0sQ0FBQyxrQ0FBc0IsQ0FBQyxDQUFDO1FBQ2hFLE9BQU8sbUJBQU8sQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLEVBQUUsRUFBRSxrQkFBa0IsR0FBRyxZQUFZLEdBQUcsb0JBQW9CLEdBQUcsVUFBVSxHQUFHLHdEQUF3RCxDQUFDLENBQUMsR0FBRyxDQUFDLFVBQUEsSUFBSTtZQUM1SyxJQUFJLGNBQWMsR0FBRyxJQUFJLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLENBQUM7WUFDekMsSUFBSSxLQUFLLEdBQUcsRUFBRSxDQUFDO1lBQ2YsSUFBSSxjQUFjLEdBQUcsU0FBUyxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ3pDLElBQUksWUFBWSxHQUFHLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNyQyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxjQUFjLEdBQUcsQ0FBQyxHQUFHLGNBQWMsR0FBRyxZQUFZLEVBQUUsQ0FBQyxFQUFFO2dCQUN0RSxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2YsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsVUFBQyxHQUFZO2dCQUN6QixJQUFJLEtBQUssR0FBRyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQ2hDLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLEdBQUcsY0FBYyxDQUFDLEdBQUcsY0FBYyxDQUFDLENBQUM7Z0JBQzVFLEtBQUssQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDO1lBQ2hCLENBQUMsQ0FBQyxDQUFDO1lBQ0gsT0FBTyxLQUFLLENBQUM7UUFDZCxDQUFDLENBQUMsQ0FBQztJQUNKLENBQUM7SUFFRixpQkFBQztBQUFELENBcE5BLEFBb05DLElBQUE7QUFwTlksZ0NBQVUiLCJmaWxlIjoiYXBwL3NoYXJlZC9oZWxwZXJzL3N0YXRpc3RpY3MudXRpbHMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSAncnhqcy9SeCdcbmltcG9ydCB7IERhdGVQaXBlIH0gZnJvbSBcIkBhbmd1bGFyL2NvbW1vblwiO1xuaW1wb3J0IHsgR3JvdXAgfSBmcm9tICcuLi9tb2RlbHMvZWxlYXJuaW5nL2dyb3VwLm1vZGVsJztcbmltcG9ydCB7IENvdXJzZUxvZywgRXhhbUxvZywgVXNlckxvZyB9IGZyb20gJy4uL21vZGVscy9lbGVhcm5pbmcvbG9nLm1vZGVsJztcbmltcG9ydCAqIGFzIF8gZnJvbSAndW5kZXJzY29yZSc7XG5pbXBvcnQgKiBhcyBtb21lbnQgZnJvbSAnbW9tZW50JztcbmltcG9ydCB7IFNFUlZFUl9EQVRFVElNRV9GT1JNQVQgfSBmcm9tICcuLi9tb2RlbHMvY29uc3RhbnRzJztcbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFQSUNvbnRleHQgfSBmcm9tICcuLi9tb2RlbHMvY29udGV4dCc7XG5pbXBvcnQgeyBRdWVzdGlvbk9wdGlvbiB9IGZyb20gJy4uL21vZGVscy9lbGVhcm5pbmcvb3B0aW9uLm1vZGVsJztcbmltcG9ydCB7IEFuc3dlciB9IGZyb20gJy4uL21vZGVscy9lbGVhcm5pbmcvYW5zd2VyLm1vZGVsJztcbmltcG9ydCB7IFN1cnZleUFuc3dlciB9IGZyb20gJy4uL21vZGVscy9lbGVhcm5pbmcvc3VydmV5LWFuc3dlci5tb2RlbCc7XG5pbXBvcnQgeyBDb21wZXRlbmN5IH0gZnJvbSAnLi4vbW9kZWxzL2VsZWFybmluZy9jb21wZXRlbmN5Lm1vZGVsJztcbmltcG9ydCB7IEFjaGl2ZW1lbnQgfSBmcm9tICcuLi9tb2RlbHMvZWxlYXJuaW5nL2FjaGlldmVtZW50Lm1vZGVsJztcbmltcG9ydCB7IENvbXBldGVuY3lMZXZlbCB9IGZyb20gJy4uL21vZGVscy9lbGVhcm5pbmcvY29tcGV0ZW5jeS1sZXZlbC5tb2RlbCc7XG5cbmV4cG9ydCBjbGFzcyBTdGF0c1V0aWxzIHtcblxuXHRjb25zdHJ1Y3RvcigpIHtcblx0fVxuXG5cdGNvbXBldGVuY3lTdGF0aXN0aWMoY29udGV4dDogQVBJQ29udGV4dCwgY29tcGV0ZW5jeTogQ29tcGV0ZW5jeSwgbGV2ZWxzOiBDb21wZXRlbmN5TGV2ZWxbXSk6IE9ic2VydmFibGU8YW55PiB7XG5cdFx0cmV0dXJuIEFjaGl2ZW1lbnQubGlzdEJ5Q29tcGV0ZW5jeShjb250ZXh0LCBjb21wZXRlbmN5LmlkKS5tYXAoc2tpbGxzID0+IHtcblx0XHRcdHZhciBza2lsbHNCeUdyb3VwID0gXy5ncm91cEJ5KHNraWxscywgJ3VzZXJfaWQnKTtcblx0XHRcdHZhciBwcm9maWxlID0ge307XG5cdFx0XHRfLmVhY2gobGV2ZWxzLCAobGV2ZWw6IENvbXBldGVuY3lMZXZlbCkgPT4ge1xuXHRcdFx0XHRwcm9maWxlW2xldmVsLmlkXSA9IDA7XG5cdFx0XHR9KTtcblx0XHRcdF8uZWFjaChza2lsbHNCeUdyb3VwLCBza2lsbExpc3QgPT4ge1xuXHRcdFx0XHRsZXQgc2tpbGw6IEFjaGl2ZW1lbnQgPSBfLm1heChza2lsbExpc3QsIChvYmo6IEFjaGl2ZW1lbnQpID0+IHtcblx0XHRcdFx0XHRyZXR1cm4gb2JqLmRhdGVfYWNxdWlyZS5nZXRUaW1lKCk7XG5cdFx0XHRcdH0pO1xuXHRcdFx0XHRwcm9maWxlW3NraWxsLmNvbXBldGVuY3lfbGV2ZWxfaWRdICs9IDE7XG5cdFx0XHR9KVxuXHRcdFx0cmV0dXJuIHByb2ZpbGU7XG5cdFx0fSk7XG5cdH1cblxuXHRjb21wZXRlbmN5U3RhdGlzdGljQnlEYXRlKGNvbnRleHQ6IEFQSUNvbnRleHQsIGNvbXBldGVuY3k6IENvbXBldGVuY3ksIGxldmVsczogQ29tcGV0ZW5jeUxldmVsW10sIHN0YXJ0RGF0ZTogRGF0ZSwgZW5kRGF0ZTogRGF0ZSk6IE9ic2VydmFibGU8YW55PiB7XG5cdFx0dmFyIHN0YXJ0RGF0ZVN0ciA9IG1vbWVudChzdGFydERhdGUpLmZvcm1hdChTRVJWRVJfREFURVRJTUVfRk9STUFUKTtcblx0XHR2YXIgZW5kRGF0ZVN0ciA9IG1vbWVudChlbmREYXRlKS5mb3JtYXQoU0VSVkVSX0RBVEVUSU1FX0ZPUk1BVCk7XG5cdFx0cmV0dXJuIEFjaGl2ZW1lbnQuc2VhcmNoQnlEYXRlQW5kQ29tcGV0ZW5jeShjb250ZXh0LCBjb21wZXRlbmN5LmlkLCBzdGFydERhdGUsIGVuZERhdGUpLm1hcChza2lsbHMgPT4ge1xuXHRcdFx0dmFyIG1vbnRoTGVuZ3RoTWlsbHMgPSAxMDAwICogNjAgKiA2MCAqIDI0ICogMzA7XG5cdFx0XHR2YXIgc2xvdHMgPSBbXTtcblx0XHRcdHZhciBzdGFyVGltZU1pbGxpcyA9IHN0YXJ0RGF0ZS5nZXRUaW1lKCk7XG5cdFx0XHR2YXIgZW5kVGltZU1pbGxzID0gZW5kRGF0ZS5nZXRUaW1lKCk7XG5cdFx0XHRmb3IgKHZhciBpID0gMDsgc3RhclRpbWVNaWxsaXMgKyBpICogbW9udGhMZW5ndGhNaWxscyA8IGVuZFRpbWVNaWxsczsgaSsrKVxuXHRcdFx0XHRzbG90cy5wdXNoKDApO1xuXHRcdFx0dmFyIHNraWxsc0J5R3JvdXAgPSBfLmdyb3VwQnkoc2tpbGxzLCAndXNlcl9pZCcpO1xuXHRcdFx0Xy5lYWNoKHNraWxsc0J5R3JvdXAsIChza2lsbExpc3Q6IEFjaGl2ZW1lbnRbXSkgPT4ge1xuXHRcdFx0XHRsZXQgc2tpbGw6IEFjaGl2ZW1lbnQgPSBfLm1heChza2lsbExpc3QsIChvYmo6IEFjaGl2ZW1lbnQpID0+IHtcblx0XHRcdFx0XHRyZXR1cm4gb2JqLmRhdGVfYWNxdWlyZS5nZXRUaW1lKCk7XG5cdFx0XHRcdH0pO1xuXHRcdFx0XHR2YXIgZGF0ZUFjcXVpcmUgPSBuZXcgRGF0ZShza2lsbC5kYXRlX2FjcXVpcmUpO1xuXHRcdFx0XHR2YXIgaW5kZXggPSBNYXRoLmZsb29yKChkYXRlQWNxdWlyZS5nZXRUaW1lKCkgLSBzdGFyVGltZU1pbGxpcykgLyBtb250aExlbmd0aE1pbGxzKTtcblx0XHRcdFx0dmFyIHByb2ZpbGUgPSBzbG90c1tpbmRleF07XG5cdFx0XHRcdGlmICghcHJvZmlsZSkge1xuXHRcdFx0XHRcdHByb2ZpbGUgPSB7fTtcblx0XHRcdFx0XHRfLmVhY2gobGV2ZWxzLCAobGV2ZWw6IENvbXBldGVuY3lMZXZlbCkgPT4ge1xuXHRcdFx0XHRcdFx0cHJvZmlsZVtsZXZlbC5pZF0gPSAwO1xuXHRcdFx0XHRcdH0pXG5cdFx0XHRcdH1cblx0XHRcdFx0cHJvZmlsZVtza2lsbC5jb21wZXRlbmN5X2xldmVsX2lkXSArPTE7XG5cdFx0XHRcdHNsb3RzW2luZGV4XSA9IHByb2ZpbGU7XG5cdFx0XHR9KTtcblx0XHRcdHJldHVybiBzbG90cztcblx0XHR9KTtcblx0fVxuXG5cdGNvdXJzZVN0YXRpc3RpY0J5RGF0ZShjb250ZXh0OiBBUElDb250ZXh0LCBzdGFydERhdGU6IERhdGUsIGVuZERhdGU6IERhdGUpOiBPYnNlcnZhYmxlPGFueT4ge1xuXHRcdHZhciBzdGFydERhdGVTdHIgPSBtb21lbnQoc3RhcnREYXRlKS5mb3JtYXQoU0VSVkVSX0RBVEVUSU1FX0ZPUk1BVCk7XG5cdFx0dmFyIGVuZERhdGVTdHIgPSBtb21lbnQoZW5kRGF0ZSkuZm9ybWF0KFNFUlZFUl9EQVRFVElNRV9GT1JNQVQpO1xuXHRcdHJldHVybiBDb3Vyc2VMb2cuc2VhcmNoKGNvbnRleHQsIFtdLCBcIlsoJ3N0YXJ0JywnPj0nLCdcIiArIHN0YXJ0RGF0ZVN0ciArIFwiJyksKCdzdGFydCcsJzw9JywnXCIgKyBlbmREYXRlU3RyICsgXCInKSwoJ3Jlc19tb2RlbCcsJz0nLCdldHJhaW5pbmcuY291cnNlJyldXCIpLm1hcChsb2dzID0+IHtcblx0XHRcdHZhciBkYXlMZW5ndGhNaWxscyA9IDEwMDAgKiA2MCAqIDYwICogMjQ7XG5cdFx0XHR2YXIgc2xvdHMgPSBbXTtcblx0XHRcdHZhciBzdGFyVGltZU1pbGxpcyA9IHN0YXJ0RGF0ZS5nZXRUaW1lKCk7XG5cdFx0XHR2YXIgZW5kVGltZU1pbGxzID0gZW5kRGF0ZS5nZXRUaW1lKCk7XG5cdFx0XHRmb3IgKHZhciBpID0gMDsgc3RhclRpbWVNaWxsaXMgKyBpICogZGF5TGVuZ3RoTWlsbHMgPCBlbmRUaW1lTWlsbHM7IGkrKylcblx0XHRcdFx0c2xvdHMucHVzaCgwKTtcblx0XHRcdF8uZWFjaChsb2dzLCAobG9nOiBDb3Vyc2VMb2cpID0+IHtcblx0XHRcdFx0dmFyIHN0YXJ0ID0gbmV3IERhdGUobG9nLnN0YXJ0KTtcblx0XHRcdFx0dmFyIGluZGV4ID0gTWF0aC5mbG9vcigoc3RhcnQuZ2V0VGltZSgpIC0gc3RhclRpbWVNaWxsaXMpIC8gZGF5TGVuZ3RoTWlsbHMpO1xuXHRcdFx0XHRzbG90c1tpbmRleF0rKztcblx0XHRcdH0pO1xuXHRcdFx0cmV0dXJuIHNsb3RzO1xuXHRcdH0pO1xuXHR9XG5cblx0Y291cnNlTWVtYmVyU3RhdGlzdGljQnlEYXRlKGNvbnRleHQ6IEFQSUNvbnRleHQsIG1lbWJlcklkOiBudW1iZXIsIGNvdXJzZUlkOiBudW1iZXIsIHN0YXJ0RGF0ZTogRGF0ZSwgZW5kRGF0ZTogRGF0ZSk6IE9ic2VydmFibGU8YW55PiB7XG5cdFx0dmFyIHN0YXJ0RGF0ZVN0ciA9IG1vbWVudChzdGFydERhdGUpLmZvcm1hdChTRVJWRVJfREFURVRJTUVfRk9STUFUKTtcblx0XHR2YXIgZW5kRGF0ZVN0ciA9IG1vbWVudChlbmREYXRlKS5mb3JtYXQoU0VSVkVSX0RBVEVUSU1FX0ZPUk1BVCk7XG5cdFx0cmV0dXJuIENvdXJzZUxvZy5zZWFyY2goY29udGV4dCwgW10sIFwiWygnbWVtYmVyX2lkJywnPScsXCIgKyBtZW1iZXJJZCArIFwiKSwoJ2NvdXJzZV9pZCcsJz0nLFwiICsgY291cnNlSWQgKyBcIiksKCdzdGFydCcsJz49JywnXCIgKyBzdGFydERhdGVTdHIgKyBcIicpLCgnc3RhcnQnLCc8PScsJ1wiICsgZW5kRGF0ZVN0ciArIFwiJyksKCdyZXNfbW9kZWwnLCc9JywnZXRyYWluaW5nLmNvdXJzZScpXVwiKS5tYXAobG9ncyA9PiB7XG5cdFx0XHR2YXIgZGF5TGVuZ3RoTWlsbHMgPSAxMDAwICogNjAgKiA2MCAqIDI0O1xuXHRcdFx0dmFyIHNsb3RzID0gW107XG5cdFx0XHR2YXIgc3RhclRpbWVNaWxsaXMgPSBzdGFydERhdGUuZ2V0VGltZSgpO1xuXHRcdFx0dmFyIGVuZFRpbWVNaWxscyA9IGVuZERhdGUuZ2V0VGltZSgpO1xuXHRcdFx0Zm9yICh2YXIgaSA9IDA7IHN0YXJUaW1lTWlsbGlzICsgaSAqIGRheUxlbmd0aE1pbGxzIDwgZW5kVGltZU1pbGxzOyBpKyspXG5cdFx0XHRcdHNsb3RzLnB1c2goMCk7XG5cdFx0XHRfLmVhY2gobG9ncywgKGxvZzogQ291cnNlTG9nKSA9PiB7XG5cdFx0XHRcdHZhciBzdGFydCA9IG5ldyBEYXRlKGxvZy5zdGFydCk7XG5cdFx0XHRcdHZhciBpbmRleCA9IE1hdGguZmxvb3IoKHN0YXJ0LmdldFRpbWUoKSAtIHN0YXJUaW1lTWlsbGlzKSAvIGRheUxlbmd0aE1pbGxzKTtcblx0XHRcdFx0c2xvdHNbaW5kZXhdKys7XG5cdFx0XHR9KTtcblx0XHRcdHJldHVybiBzbG90cztcblx0XHR9KTtcblx0fVxuXG5cdGV4YW1BbnN3ZXJTdGF0aXN0aWNzKGFuc3dlcnM6IGFueVtdKTogYW55IHtcblx0XHR2YXIgbXVsdGljaG9pY2VBbnN3ZXIgPSBfLmZpbHRlcihhbnN3ZXJzLCBhbnMgPT4ge1xuXHRcdFx0cmV0dXJuIGFuc1tcInF1ZXN0aW9uX3R5cGVcIl0gPT0gJ3NjJyB8fCBhbnNbXCJxdWVzdGlvbl90eXBlXCJdID09ICdtYyc7XG5cdFx0fSk7XG5cdFx0dmFyIHJhdGluZ0Fuc3dlciA9IF8uZmlsdGVyKGFuc3dlcnMsIGFucyA9PiB7XG5cdFx0XHRyZXR1cm4gYW5zW1wicXVlc3Rpb25fdHlwZVwiXSA9PSAncmF0ZSc7XG5cdFx0fSk7XG5cdFx0dmFyIG9wZW5BbnN3ZXIgPSBfLmZpbHRlcihhbnN3ZXJzLCBhbnMgPT4ge1xuXHRcdFx0cmV0dXJuIGFuc1tcInF1ZXN0aW9uX3R5cGVcIl0gPT0gJ2V4dCc7XG5cdFx0fSk7XG5cdFx0cmV0dXJuIHtcblx0XHRcdCdtdWx0aWNob2ljZSc6IHRoaXMubXVsdGljaG9pY2VBbnN3ZXJTdGF0aXN0aWNzKGFuc3dlcnMpLFxuXHRcdFx0J3JhdGluZyc6IHRoaXMucmF0aW5nQW5zd2VyU3RhdGlzdGljcyhhbnN3ZXJzKSxcblx0XHRcdCdvcGVuJzogdGhpcy5vcGVuQW5zd2VyU3RhdGlzdGljcyhhbnN3ZXJzKVxuXHRcdH1cblx0fVxuXG5cdHN1cnZleUFuc3dlclN0YXRpc3RpY3MoYW5zd2VyczogYW55W10pOiBhbnkge1xuXHRcdHZhciBtdWx0aWNob2ljZUFuc3dlciA9IF8uZmlsdGVyKGFuc3dlcnMsIGFucyA9PiB7XG5cdFx0XHRyZXR1cm4gYW5zW1wicXVlc3Rpb25fdHlwZVwiXSA9PSAnc2MnIHx8IGFuc1tcInF1ZXN0aW9uX3R5cGVcIl0gPT0gJ21jJztcblx0XHR9KTtcblx0XHR2YXIgcmF0aW5nQW5zd2VyID0gXy5maWx0ZXIoYW5zd2VycywgYW5zID0+IHtcblx0XHRcdHJldHVybiBhbnNbXCJxdWVzdGlvbl90eXBlXCJdID09ICdyYXRlJztcblx0XHR9KTtcblx0XHR2YXIgb3BlbkFuc3dlciA9IF8uZmlsdGVyKGFuc3dlcnMsIGFucyA9PiB7XG5cdFx0XHRyZXR1cm4gYW5zW1wicXVlc3Rpb25fdHlwZVwiXSA9PSAnZXh0Jztcblx0XHR9KTtcblx0XHRyZXR1cm4ge1xuXHRcdFx0J211bHRpY2hvaWNlJzogdGhpcy5tdWx0aWNob2ljZUFuc3dlclN0YXRpc3RpY3MoYW5zd2VycyksXG5cdFx0XHQncmF0aW5nJzogdGhpcy5yYXRpbmdBbnN3ZXJTdGF0aXN0aWNzKGFuc3dlcnMpLFxuXHRcdFx0J29wZW4nOiB0aGlzLm9wZW5BbnN3ZXJTdGF0aXN0aWNzKGFuc3dlcnMpXG5cdFx0fVxuXHR9XG5cblx0b3BlbkFuc3dlclN0YXRpc3RpY3MoYW5zd2VyczogYW55W10pOiBhbnkge1xuXHRcdHZhciBxdWVzdGlvbkF0dGVtcHRzID0ge307XG5cdFx0Xy5lYWNoKGFuc3dlcnMsIGFucyA9PiB7XG5cdFx0XHRpZiAoIXF1ZXN0aW9uQXR0ZW1wdHNbYW5zW1wicXVlc3Rpb25faWRcIl1dKVxuXHRcdFx0XHRxdWVzdGlvbkF0dGVtcHRzW2Fuc1tcInF1ZXN0aW9uX2lkXCJdXSA9IFtdO1xuXHRcdFx0cXVlc3Rpb25BdHRlbXB0c1thbnNbXCJxdWVzdGlvbl9pZFwiXV0ucHVzaChhbnMudGV4dCk7XG5cdFx0fSk7XG5cdH1cblxuXHRyYXRpbmdBbnN3ZXJTdGF0aXN0aWNzKGFuc3dlcnM6IGFueVtdKTogYW55IHtcblx0XHR2YXIgcmF0aW5nUGVyY2VudGFnZSA9IHt9O1xuXHRcdHZhciBxdWVzdGlvbkF0dGVtcHRzID0ge307XG5cdFx0Xy5lYWNoKGFuc3dlcnMsIGFucyA9PiB7XG5cdFx0XHRpZiAoIXF1ZXN0aW9uQXR0ZW1wdHNbYW5zW1wicXVlc3Rpb25faWRcIl1dKVxuXHRcdFx0XHRxdWVzdGlvbkF0dGVtcHRzW2Fuc1tcInF1ZXN0aW9uX2lkXCJdXSA9IDE7XG5cdFx0XHRlbHNlXG5cdFx0XHRcdHF1ZXN0aW9uQXR0ZW1wdHNbYW5zW1wicXVlc3Rpb25faWRcIl1dKys7XG5cdFx0XHRpZiAoIXJhdGluZ1BlcmNlbnRhZ2VbYW5zW1wicXVlc3Rpb25faWRcIl1dKVxuXHRcdFx0XHRyYXRpbmdQZXJjZW50YWdlW2Fuc1tcInF1ZXN0aW9uX2lkXCJdXSA9IDA7XG5cdFx0XHRlbHNlXG5cdFx0XHRcdHJhdGluZ1BlcmNlbnRhZ2VbYW5zW1wicXVlc3Rpb25faWRcIl1dKys7XG5cdFx0XHRpZiAoYW5zLnRleHQpXG5cdFx0XHRcdHJhdGluZ1BlcmNlbnRhZ2VbYW5zW1wicXVlc3Rpb25faWRcIl1dICs9ICthbnMudGV4dDtcblx0XHR9KTtcblx0XHRyZXR1cm4gXy5tYXAocmF0aW5nUGVyY2VudGFnZSwgKHJhdGUsIGlkKSA9PiB7XG5cdFx0XHRyZXR1cm4gcmF0aW5nUGVyY2VudGFnZVtpZF0gLyBxdWVzdGlvbkF0dGVtcHRzW2lkXTtcblx0XHR9KTtcblx0fVxuXG5cdG11bHRpY2hvaWNlQW5zd2VyU3RhdGlzdGljcyhhbnN3ZXJzOiBhbnlbXSk6IGFueSB7XG5cdFx0dmFyIG9wdGlvbjJRdWVzdGlvbiA9IHt9O1xuXHRcdHZhciBvcHRpb25JZHMgPSBbXTtcblx0XHR2YXIgb3B0aW9uQXR0ZW1wdHMgPSB7fTtcblx0XHR2YXIgcXVlc3Rpb25BdHRlbXB0cyA9IHt9O1xuXHRcdF8uZWFjaChhbnN3ZXJzLCAoYW5zOiBBbnN3ZXIpID0+IHtcblx0XHRcdHZhciBzZWxlY3RlZE9wdGlvbklkcyA9IFtdO1xuXHRcdFx0aWYgKGFucy5vcHRpb25faWQpXG5cdFx0XHRcdHNlbGVjdGVkT3B0aW9uSWRzLnB1c2goYW5zLm9wdGlvbl9pZCk7XG5cdFx0XHRlbHNlIGlmIChhbnMuanNvbilcblx0XHRcdFx0c2VsZWN0ZWRPcHRpb25JZHMgPSBKU09OLnBhcnNlKGFucy5qc29uKTtcblx0XHRcdG9wdGlvbklkcyA9IG9wdGlvbklkcy5jb25jYXQoc2VsZWN0ZWRPcHRpb25JZHMpO1xuXHRcdFx0Xy5lYWNoKHNlbGVjdGVkT3B0aW9uSWRzLCBpZCA9PiB7XG5cdFx0XHRcdG9wdGlvbjJRdWVzdGlvbltpZF0gPSBhbnNbXCJxdWVzdGlvbl9pZFwiXTtcblx0XHRcdFx0aWYgKCFvcHRpb25BdHRlbXB0c1tpZF0pXG5cdFx0XHRcdFx0b3B0aW9uQXR0ZW1wdHNbaWRdID0gMTtcblx0XHRcdFx0ZWxzZVxuXHRcdFx0XHRcdG9wdGlvbkF0dGVtcHRzW2lkXSsrO1xuXHRcdFx0fSk7XG5cdFx0XHRpZiAoIXF1ZXN0aW9uQXR0ZW1wdHNbYW5zW1wicXVlc3Rpb25faWRcIl1dKVxuXHRcdFx0XHRxdWVzdGlvbkF0dGVtcHRzW2Fuc1tcInF1ZXN0aW9uX2lkXCJdXSA9IDE7XG5cdFx0XHRlbHNlXG5cdFx0XHRcdHF1ZXN0aW9uQXR0ZW1wdHNbYW5zW1wicXVlc3Rpb25faWRcIl1dKys7XG5cdFx0fSk7XG5cdFx0b3B0aW9uSWRzID0gXy51bmlxKG9wdGlvbklkcyk7XG5cdFx0dmFyIG9wdGlvblBlcmNlbnRhZ2UgPSB7fTtcblx0XHRfLmVhY2gob3B0aW9uSWRzLCBvcHRpb25JZCA9PiB7XG5cdFx0XHR2YXIgcXVlc3Rpb25JZCA9IG9wdGlvbjJRdWVzdGlvbltvcHRpb25JZF07XG5cdFx0XHR2YXIgcXVlc3Rpb25BdHRlbXB0ID0gcXVlc3Rpb25BdHRlbXB0c1txdWVzdGlvbklkXTtcblx0XHRcdHZhciBvcHRpb25BdHRlbXB0ID0gb3B0aW9uQXR0ZW1wdHNbb3B0aW9uSWRdO1xuXHRcdFx0aWYgKHF1ZXN0aW9uQXR0ZW1wdClcblx0XHRcdFx0b3B0aW9uUGVyY2VudGFnZVtvcHRpb25JZF0gPSBvcHRpb25BdHRlbXB0ICogMTAwIC8gcXVlc3Rpb25BdHRlbXB0O1xuXHRcdFx0ZWxzZVxuXHRcdFx0XHRvcHRpb25QZXJjZW50YWdlW29wdGlvbklkXSA9IDA7XG5cblx0XHR9KTtcblx0XHRyZXR1cm4gb3B0aW9uUGVyY2VudGFnZTtcblx0fVxuXG5cdHVzZXJMb2dpblN0YXRpc3RpY0J5RGF0ZShjb250ZXh0OiBBUElDb250ZXh0LCBzdGFydERhdGU6IERhdGUsIGVuZERhdGU6IERhdGUpOiBPYnNlcnZhYmxlPGFueT4ge1xuXHRcdHZhciBzdGFydERhdGVTdHIgPSBtb21lbnQoc3RhcnREYXRlKS5mb3JtYXQoU0VSVkVSX0RBVEVUSU1FX0ZPUk1BVCk7XG5cdFx0dmFyIGVuZERhdGVTdHIgPSBtb21lbnQoZW5kRGF0ZSkuZm9ybWF0KFNFUlZFUl9EQVRFVElNRV9GT1JNQVQpO1xuXHRcdHJldHVybiBVc2VyTG9nLnNlYXJjaChjb250ZXh0LCBbXSwgXCJbKCdzdGFydCcsJz49JywnXCIgKyBzdGFydERhdGVTdHIgKyBcIicpLCgnc3RhcnQnLCc8PScsJ1wiICsgZW5kRGF0ZVN0ciArIFwiJyksKCdyZXNfbW9kZWwnLCc9JywncmVzLnVzZXJzJyksKCdjb2RlJywnPScsJ0xPR0lOJyldXCIpLm1hcChsb2dzID0+IHtcblx0XHRcdHZhciBkYXlMZW5ndGhNaWxscyA9IDEwMDAgKiA2MCAqIDYwICogMjQ7XG5cdFx0XHR2YXIgc2xvdHMgPSBbXTtcblx0XHRcdHZhciBzdGFyVGltZU1pbGxpcyA9IHN0YXJ0RGF0ZS5nZXRUaW1lKCk7XG5cdFx0XHR2YXIgZW5kVGltZU1pbGxzID0gZW5kRGF0ZS5nZXRUaW1lKCk7XG5cdFx0XHRmb3IgKHZhciBpID0gMDsgc3RhclRpbWVNaWxsaXMgKyBpICogZGF5TGVuZ3RoTWlsbHMgPCBlbmRUaW1lTWlsbHM7IGkrKylcblx0XHRcdFx0c2xvdHMucHVzaCgwKTtcblx0XHRcdF8uZWFjaChsb2dzLCAobG9nOiBVc2VyTG9nKSA9PiB7XG5cdFx0XHRcdHZhciBzdGFydCA9IG5ldyBEYXRlKGxvZy5zdGFydCk7XG5cdFx0XHRcdHZhciBpbmRleCA9IE1hdGguZmxvb3IoKHN0YXJ0LmdldFRpbWUoKSAtIHN0YXJUaW1lTWlsbGlzKSAvIGRheUxlbmd0aE1pbGxzKTtcblx0XHRcdFx0c2xvdHNbaW5kZXhdKys7XG5cdFx0XHR9KTtcblx0XHRcdHJldHVybiBzbG90cztcblx0XHR9KTtcblx0fVxuXG59XG4iXX0=
