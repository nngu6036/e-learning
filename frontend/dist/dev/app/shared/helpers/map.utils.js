"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
require("./reflect");
var decorator_1 = require("../models/decorator");
var moment = require("moment");
var constants_1 = require("../models/constants");
var decorator_2 = require("../models/decorator");
var MapUtils = (function () {
    function MapUtils() {
    }
    MapUtils.isPrimitive = function (obj) {
        switch (typeof obj) {
            case "string":
            case "number":
            case "boolean":
                return true;
        }
        return !!(obj instanceof String || obj === String ||
            obj instanceof Number || obj === Number ||
            obj instanceof Boolean || obj === Boolean);
    };
    MapUtils.isDate = function (clazz) {
        return (clazz instanceof Date);
    };
    MapUtils.isArray = function (object) {
        if (object === Array) {
            return true;
        }
        else if (typeof Array.isArray === "function") {
            return Array.isArray(object);
        }
        else {
            return !!(object instanceof Array);
        }
    };
    MapUtils.getClazz = function (target, propertyKey) {
        return Reflect.getMetadata("design:type", target, propertyKey);
    };
    MapUtils.getFieldProperty = function (target, propertyKey) {
        return Reflect.getMetadata(decorator_1.FIELD_METADATA_KEY, target, propertyKey);
    };
    MapUtils.getLocalProperty = function (target, propertyKey) {
        return Reflect.getMetadata(decorator_1.FIELD_METADATA_KEY, target, propertyKey);
    };
    MapUtils.deserialize = function (clazz, jsonObject) {
        if ((clazz === undefined) || (jsonObject === undefined))
            return undefined;
        var obj = new clazz();
        Object.keys(obj).forEach(function (key) {
            var propertyMetadataFn = function (propertyMetadata) {
                var propertyName = propertyMetadata.name || key;
                var innerJson = jsonObject ? jsonObject[propertyName] : undefined;
                var clazz = MapUtils.getClazz(obj, key);
                if (!jsonObject[propertyName])
                    return null;
                if (MapUtils.isArray(clazz)) {
                    var metadata_1 = MapUtils.getLocalProperty(obj, key);
                    if (metadata_1.clazz || MapUtils.isPrimitive(clazz)) {
                        if (innerJson && MapUtils.isArray(innerJson)) {
                            return innerJson.map(function (item) { return MapUtils.deserialize(metadata_1.clazz, item); });
                        }
                        else {
                            return undefined;
                        }
                    }
                    else {
                        return innerJson;
                    }
                }
                else if (MapUtils.isPrimitive(clazz)) {
                    return jsonObject ? jsonObject[propertyName] : undefined;
                }
                else if (MapUtils.isDate(new clazz())) {
                    return jsonObject ? moment(jsonObject[propertyName], constants_1.SERVER_DATETIME_FORMAT).toDate() : undefined;
                }
                else {
                    return MapUtils.deserialize(clazz, innerJson);
                }
            };
            var propertyMetadata = MapUtils.getFieldProperty(obj, key);
            if (propertyMetadata) {
                obj[key] = propertyMetadataFn(propertyMetadata);
            }
            else {
                if (jsonObject && jsonObject[key] !== undefined) {
                    obj[key] = jsonObject[key];
                }
            }
        });
        return obj;
    };
    MapUtils.deserializeModel = function (model, jsonObject) {
        if (!jsonObject)
            return undefined;
        var obj = decorator_2.ModelRegister.Instance.instantiateObject(model);
        Object.keys(obj).forEach(function (key) {
            var propertyMetadataFn = function (propertyMetadata) {
                var propertyName = propertyMetadata.name || key;
                var innerJson = jsonObject ? jsonObject[propertyName] : undefined;
                var clazz = MapUtils.getClazz(obj, key);
                if (!jsonObject[propertyName])
                    return null;
                if (MapUtils.isPrimitive(clazz)) {
                    return jsonObject ? jsonObject[propertyName] : undefined;
                }
                else if (MapUtils.isDate(new clazz())) {
                    return jsonObject ? moment(jsonObject[propertyName], constants_1.SERVER_DATETIME_FORMAT).toDate() : undefined;
                }
            };
            var propertyMetadata = MapUtils.getFieldProperty(obj, key);
            if (propertyMetadata) {
                obj[key] = propertyMetadataFn(propertyMetadata);
            }
            else {
                if (jsonObject && jsonObject[key] !== undefined) {
                    obj[key] = jsonObject[key];
                }
            }
        });
        return obj;
    };
    MapUtils.serialize = function (object) {
        if (object === undefined)
            return {};
        var jsonObject = {};
        Object.keys(object).forEach(function (key) {
            if (MapUtils.isDate(object[key]))
                jsonObject[key] = moment(object[key]).format(constants_1.SERVER_DATETIME_FORMAT);
            else {
                jsonObject[key] = object[key];
                if (jsonObject[key] && jsonObject[key] instanceof Object)
                    jsonObject[key] = null;
            }
        });
        return jsonObject;
    };
    return MapUtils;
}());
exports.MapUtils = MapUtils;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC9zaGFyZWQvaGVscGVycy9tYXAudXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxxQkFBbUI7QUFDbkIsaURBQXVGO0FBQ3ZGLCtCQUFpQztBQUNqQyxpREFBMkQ7QUFDM0QsaURBQW9EO0FBRXBEO0lBQUE7SUFrSUEsQ0FBQztJQWpJVSxvQkFBVyxHQUFsQixVQUFtQixHQUFPO1FBQ3RCLFFBQVEsT0FBTyxHQUFHLEVBQUU7WUFDaEIsS0FBSyxRQUFRLENBQUM7WUFDZCxLQUFLLFFBQVEsQ0FBQztZQUNkLEtBQUssU0FBUztnQkFDVixPQUFPLElBQUksQ0FBQztTQUNuQjtRQUNELE9BQU8sQ0FBQyxDQUFDLENBQUMsR0FBRyxZQUFZLE1BQU0sSUFBSSxHQUFHLEtBQUssTUFBTTtZQUNqRCxHQUFHLFlBQVksTUFBTSxJQUFJLEdBQUcsS0FBSyxNQUFNO1lBQ3ZDLEdBQUcsWUFBWSxPQUFPLElBQUksR0FBRyxLQUFLLE9BQU8sQ0FBQyxDQUFDO0lBQy9DLENBQUM7SUFFTSxlQUFNLEdBQWIsVUFBYyxLQUFTO1FBQ25CLE9BQU8sQ0FBQyxLQUFLLFlBQVksSUFBSSxDQUFDLENBQUM7SUFDbkMsQ0FBQztJQUVNLGdCQUFPLEdBQWQsVUFBZSxNQUFVO1FBQ3JCLElBQUksTUFBTSxLQUFLLEtBQUssRUFBRTtZQUNsQixPQUFPLElBQUksQ0FBQztTQUNmO2FBQU0sSUFBSSxPQUFPLEtBQUssQ0FBQyxPQUFPLEtBQUssVUFBVSxFQUFFO1lBQzVDLE9BQU8sS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUNoQzthQUNJO1lBQ0QsT0FBTyxDQUFDLENBQUMsQ0FBQyxNQUFNLFlBQVksS0FBSyxDQUFDLENBQUM7U0FDdEM7SUFDTCxDQUFDO0lBRU0saUJBQVEsR0FBZixVQUFnQixNQUFXLEVBQUUsV0FBbUI7UUFDbEQsT0FBTyxPQUFPLENBQUMsV0FBVyxDQUFDLGFBQWEsRUFBRSxNQUFNLEVBQUUsV0FBVyxDQUFDLENB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TTtvQkFDcEQsVUFBVSxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQzthQUM5QjtRQUVMLENBQUMsQ0FBQyxDQUFDO1FBQ0gsT0FBTyxVQUFVLENBQUM7SUFDdEIsQ0FBQztJQUNMLGVBQUM7QUFBRCxDQWxJQSxBQWtJQyxJQUFBO0FBbElZLDRCQUFRIiwiZmlsZSI6ImFwcC9zaGFyZWQvaGVscGVycy9tYXAudXRpbHMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgJy4vcmVmbGVjdCc7XG5pbXBvcnQgeyBGSUVMRF9NRVRBREFUQV9LRVksIEZpZWxkUHJvcGVydHksIElGaWVsZE1ldGFEYXRhIH0gZnJvbSAnLi4vbW9kZWxzL2RlY29yYXRvcidcbmltcG9ydCAqIGFzIG1vbWVudCBmcm9tICdtb21lbnQnO1xuaW1wb3J0IHtTRVJWRVJfREFURVRJTUVfRk9STUFUfSBmcm9tICcuLi9tb2RlbHMvY29uc3RhbnRzJztcbmltcG9ydCB7IE1vZGVsUmVnaXN0ZXIgfSBmcm9tICcuLi9tb2RlbHMvZGVjb3JhdG9yJztcblxuZXhwb3J0IGNsYXNzIE1hcFV0aWxzIHtcbiAgICBzdGF0aWMgaXNQcmltaXRpdmUob2JqOmFueSkge1xuICAgICAgICBzd2l0Y2ggKHR5cGVvZiBvYmopIHtcbiAgICAgICAgICAgIGNhc2UgXCJzdHJpbmdcIjpcbiAgICAgICAgICAgIGNhc2UgXCJudW1iZXJcIjpcbiAgICAgICAgICAgIGNhc2UgXCJib29sZWFuXCI6XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuICEhKG9iaiBpbnN0YW5jZW9mIFN0cmluZyB8fCBvYmogPT09IFN0cmluZyB8fFxuICAgICAgICBvYmogaW5zdGFuY2VvZiBOdW1iZXIgfHwgb2JqID09PSBOdW1iZXIgfHxcbiAgICAgICAgb2JqIGluc3RhbmNlb2YgQm9vbGVhbiB8fCBvYmogPT09IEJvb2xlYW4pO1xuICAgIH1cblxuICAgIHN0YXRpYyBpc0RhdGUoY2xheno6YW55KSB7XG4gICAgICAgIHJldHVybiAoY2xhenogaW5zdGFuY2VvZiBEYXRlKTtcbiAgICB9XG5cbiAgICBzdGF0aWMgaXNBcnJheShvYmplY3Q6YW55KSB7XG4gICAgICAgIGlmIChvYmplY3QgPT09IEFycmF5KSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgQXJyYXkuaXNBcnJheSA9PT0gXCJmdW5jdGlvblwiKSB7XG4gICAgICAgICAgICByZXR1cm4gQXJyYXkuaXNBcnJheShvYmplY3QpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuICEhKG9iamVjdCBpbnN0YW5jZW9mIEFycmF5KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHN0YXRpYyBnZXRDbGF6eih0YXJnZXQ6IGFueSwgcHJvcGVydHlLZXk6IHN0cmluZyk6IGFueSB7XG5cdFx0cmV0dXJuIFJlZmxlY3QuZ2V0TWV0YWRhdGEoXCJkZXNpZ246dHlwZVwiLCB0YXJnZXQsIHByb3BlcnR5S2V5KVxuXHR9XG5cblx0c3RhdGljIGdldEZpZWxkUHJvcGVydHk8VD4odGFyZ2V0OiBhbnksIHByb3BlcnR5S2V5OiBzdHJpbmcpOiAgSUZpZWxkTWV0YURhdGE8VD4ge1xuXHRcdHJldHVybiBSZWZsZWN0LmdldE1ldGFkYXRhKEZJRUxEX01FVEFEQVRBX0tFWSwgdGFyZ2V0LCBwcm9wZXJ0eUtleSk7XG5cdH1cblxuICAgIHN0YXRpYyBnZXRMb2NhbFByb3BlcnR5PFQ+KHRhcmdldDogYW55LCBwcm9wZXJ0eUtleTogc3RyaW5nKTogIElGaWVsZE1ldGFEYXRhPFQ+IHtcbiAgICAgICAgcmV0dXJuIFJlZmxlY3QuZ2V0TWV0YWRhdGEoRklFTERfTUVUQURBVEFfS0VZLCB0YXJnZXQsIHByb3BlcnR5S2V5KTtcbiAgICB9XG5cbiAgICBzdGF0aWMgZGVzZXJpYWxpemU8VD4oY2xheno6e25ldygpOiBUfSwganNvbk9iamVjdDphbnkpIHtcbiAgICAgICAgaWYgKChjbGF6eiA9PT0gdW5kZWZpbmVkKSB8fCAoanNvbk9iamVjdCA9PT0gdW5kZWZpbmVkKSkgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgbGV0IG9iajphbnkgPSBuZXcgY2xhenooKTtcbiAgICAgICAgT2JqZWN0LmtleXMob2JqKS5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgICAgICAgIGxldCBwcm9wZXJ0eU1ldGFkYXRhRm46KElGaWVsZE1ldGFEYXRhKSA9PiBhbnkgPSAocHJvcGVydHlNZXRhZGF0YSk9PiB7XG4gICAgICAgICAgICAgICAgbGV0IHByb3BlcnR5TmFtZSA9IHByb3BlcnR5TWV0YWRhdGEubmFtZSB8fCBrZXk7XG4gICAgICAgICAgICAgICAgbGV0IGlubmVySnNvbiA9IGpzb25PYmplY3QgPyBqc29uT2JqZWN0W3Byb3BlcnR5TmFtZV0gOiB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgbGV0IGNsYXp6ID0gTWFwVXRpbHMuZ2V0Q2xhenoob2JqLCBrZXkpO1xuICAgICAgICAgICAgICAgIGlmICghanNvbk9iamVjdFtwcm9wZXJ0eU5hbWVdKVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgICAgICBpZiAoTWFwVXRpbHMuaXNBcnJheShjbGF6eikpIHtcbiAgICAgICAgICAgICAgICAgICAgbGV0IG1ldGFkYXRhID0gTWFwVXRpbHMuZ2V0TG9jYWxQcm9wZXJ0eShvYmosIGtleSk7XG4gICAgICAgICAgICAgICAgICAgIGlmIChtZXRhZGF0YS5jbGF6eiB8fCBNYXBVdGlscy5pc1ByaW1pdGl2ZShjbGF6eikpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpbm5lckpzb24gJiYgTWFwVXRpbHMuaXNBcnJheShpbm5lckpzb24pKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlubmVySnNvbi5tYXAoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIChpdGVtOmFueSk9PiBNYXBVdGlscy5kZXNlcmlhbGl6ZShtZXRhZGF0YS5jbGF6eiwgaXRlbSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlubmVySnNvbjtcbiAgICAgICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChNYXBVdGlscy5pc1ByaW1pdGl2ZShjbGF6eikpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGpzb25PYmplY3QgPyBqc29uT2JqZWN0W3Byb3BlcnR5TmFtZV0gOiB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChNYXBVdGlscy5pc0RhdGUobmV3IGNsYXp6KCkpKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBqc29uT2JqZWN0ID8gbW9tZW50KGpzb25PYmplY3RbcHJvcGVydHlOYW1lXSxTRVJWRVJfREFURVRJTUVfRk9STUFUKS50b0RhdGUoKTogdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBNYXBVdGlscy5kZXNlcmlhbGl6ZShjbGF6eiwgaW5uZXJKc29uKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBsZXQgcHJvcGVydHlNZXRhZGF0YSA9IE1hcFV0aWxzLmdldEZpZWxkUHJvcGVydHkob2JqLCBrZXkpO1xuICAgICAgICAgICAgaWYgKHByb3BlcnR5TWV0YWRhdGEpIHtcbiAgICAgICAgICAgICAgICBvYmpba2V5XSA9IHByb3BlcnR5TWV0YWRhdGFGbihwcm9wZXJ0eU1ldGFkYXRhKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKGpzb25PYmplY3QgJiYganNvbk9iamVjdFtrZXldICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgb2JqW2tleV0gPSBqc29uT2JqZWN0W2tleV07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIG9iajtcbiAgICB9XG5cbiAgICBzdGF0aWMgZGVzZXJpYWxpemVNb2RlbChtb2RlbDpzdHJpbmcsIGpzb25PYmplY3Q6YW55KSB7XG4gICAgICAgIGlmICghanNvbk9iamVjdCkgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICAgICAgbGV0IG9iajphbnkgPSBNb2RlbFJlZ2lzdGVyLkluc3RhbmNlLmluc3RhbnRpYXRlT2JqZWN0KG1vZGVsKTtcbiAgICAgICAgT2JqZWN0LmtleXMob2JqKS5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgICAgICAgIGxldCBwcm9wZXJ0eU1ldGFkYXRhRm46KElGaWVsZE1ldGFEYXRhKSA9PiBhbnkgPSAocHJvcGVydHlNZXRhZGF0YSk9PiB7XG4gICAgICAgICAgICAgICAgbGV0IHByb3BlcnR5TmFtZSA9IHByb3BlcnR5TWV0YWRhdGEubmFtZSB8fCBrZXk7XG4gICAgICAgICAgICAgICAgbGV0IGlubmVySnNvbiA9IGpzb25PYmplY3QgPyBqc29uT2JqZWN0W3Byb3BlcnR5TmFtZV0gOiB1bmRlZmluZWQ7XG4gICAgICAgICAgICAgICAgbGV0IGNsYXp6ID0gTWFwVXRpbHMuZ2V0Q2xhenoob2JqLCBrZXkpO1xuICAgICAgICAgICAgICAgIGlmICghanNvbk9iamVjdFtwcm9wZXJ0eU5hbWVdKVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgICAgICBpZiAoTWFwVXRpbHMuaXNQcmltaXRpdmUoY2xhenopKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBqc29uT2JqZWN0ID8ganNvbk9iamVjdFtwcm9wZXJ0eU5hbWVdIDogdW5kZWZpbmVkO1xuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoTWFwVXRpbHMuaXNEYXRlKG5ldyBjbGF6eigpKSkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4ganNvbk9iamVjdCA/IG1vbWVudChqc29uT2JqZWN0W3Byb3BlcnR5TmFtZV0sU0VSVkVSX0RBVEVUSU1FX0ZPUk1BVCkudG9EYXRlKCk6IHVuZGVmaW5lZDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICBsZXQgcHJvcGVydHlNZXRhZGF0YSA9IE1hcFV0aWxzLmdldEZpZWxkUHJvcGVydHkob2JqLCBrZXkpO1xuICAgICAgICAgICAgaWYgKHByb3BlcnR5TWV0YWRhdGEpIHtcbiAgICAgICAgICAgICAgICBvYmpba2V5XSA9IHByb3BlcnR5TWV0YWRhdGFGbihwcm9wZXJ0eU1ldGFkYXRhKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKGpzb25PYmplY3QgJiYganNvbk9iamVjdFtrZXldICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgICAgICAgICAgICAgb2JqW2tleV0gPSBqc29uT2JqZWN0W2tleV07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIG9iajtcbiAgICB9XG5cbiAgICBzdGF0aWMgc2VyaWFsaXplKG9iamVjdDphbnkpOmFueSB7XG4gICAgICAgIGlmIChvYmplY3QgPT09IHVuZGVmaW5lZCkgcmV0dXJuIHt9O1xuICAgICAgICBsZXQganNvbk9iamVjdDphbnkgPSB7fTtcbiAgICAgICAgT2JqZWN0LmtleXMob2JqZWN0KS5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgICAgICAgIGlmIChNYXBVdGlscy5pc0RhdGUob2JqZWN0W2tleV0pKVxuICAgICAgICAgICAgICAgIGpzb25PYmplY3Rba2V5XSA9IG1vbWVudChvYmplY3Rba2V5XSkuZm9ybWF0KFNFUlZFUl9EQVRFVElNRV9GT1JNQVQpO1xuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAganNvbk9iamVjdFtrZXldID0gb2JqZWN0W2tleV07XG4gICAgICAgICAgICAgICAgaWYgKGpzb25PYmplY3Rba2V5XSAmJiBqc29uT2JqZWN0W2tleV0gaW5zdGFuY2VvZiBPYmplY3QpXG4gICAgICAgICAgICAgICAgICAgIGpzb25PYmplY3Rba2V5XSA9IG51bGw7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiBqc29uT2JqZWN0O1xuICAgIH1cbn1cbiJdfQ==
