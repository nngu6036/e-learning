"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var _ = require("underscore");
var SyllabusUtils = (function () {
    function SyllabusUtils() {
    }
    SyllabusUtils.prototype.buildGroupTree = function (units) {
        return this.buildSubTree(null, units);
    };
    SyllabusUtils.prototype.getSubGroup = function (units, parentId) {
        var _this = this;
        var subUnits = _.filter(units, function (unit) {
            return _this.isSubUnit(units, unit, parentId);
        });
    };
    SyllabusUtils.prototype.flattenTree = function (tree) {
        var nodeList = [];
        for (var i = 0; i < tree.length; i++)
            nodeList = nodeList.concat(this.flattenNode(tree[i]));
        return nodeList;
    };
    SyllabusUtils.prototype.flattenNode = function (treeNode) {
        var nodeList = [treeNode];
        for (var i = 0; i < treeNode.children.length; i++)
            nodeList = nodeList.concat(this.flattenNode(treeNode.children[i]));
        return nodeList;
    };
    SyllabusUtils.prototype.isSubUnit = function (units, target, parentId) {
        while (target) {
            if (target.id == parentId)
                return true;
            if (target.parent_id)
                target = _.find(units, function (unit) {
                    return unit.id == target.parent_id;
                });
            else
                target = null;
        }
        return false;
    };
    SyllabusUtils.prototype.buildSubTree = function (parentUnit, units) {
        var _this = this;
        var subTrees = [];
        var directChilds = [];
        if (!parentUnit)
            directChilds = _.filter(units, function (unit) {
                return !unit.parent_id;
            });
        else {
            directChilds = _.filter(units, function (unit) {
                return parentUnit.id == unit.parent_id;
            });
        }
        _.each(directChilds, function (unit) {
            var children = _this.buildSubTree(unit, units);
            children = _.sortBy(children, function (obj) { return obj.data.order; });
            subTrees.push({
                data: unit,
                label: unit.name,
                icon: unit.icon,
                expanded: true,
                children: children
            });
        });
        subTrees = _.sortBy(subTrees, function (obj) { return obj.data.order; });
        return subTrees;
    };
    SyllabusUtils.prototype.moveUp = function (tree, node) {
        var siblings = [];
        if (!node.parent) {
            siblings = tree;
        }
        else {
            var parentNode = this.findTreeNode(tree, node.parent.data.id);
            siblings = parentNode.children;
        }
        var curIndex = _.findIndex(siblings, function (obj) { return obj.data.id == node.data.id; });
        if (curIndex > 0) {
            var prevNode = siblings[curIndex - 1];
            var prevData = prevNode.data;
            var currentData = node.data;
            var tmp = prevData.order;
            prevData.order = currentData.order;
            currentData.order = tmp;
            siblings[curIndex] = prevNode;
            siblings[curIndex - 1] = node;
        }
    };
    SyllabusUtils.prototype.moveDown = function (tree, node) {
        var siblings = [];
        if (!node.parent) {
            siblings = tree;
        }
        else {
            var parentNode = this.findTreeNode(tree, node.parent.data.id);
            siblings = parentNode.children;
        }
        var curIndex = _.findIndex(siblings, function (obj) { return obj.data.id == node.data.id; });
        if (curIndex < siblings.length - 1) {
            var nextNode = siblings[curIndex + 1];
            var nextData = nextNode.data;
            var currentData = node.data;
            var tmp = nextData.order;
            nextData.order = currentData.order;
            currentData.order = tmp;
            siblings[curIndex] = nextNode;
            siblings[curIndex + 1] = node;
        }
    };
    SyllabusUtils.prototype.addRootNode = function (tree, unit) {
        tree.push({
            data: unit,
            label: unit.name,
            icon: unit.icon,
            children: []
        });
    };
    SyllabusUtils.prototype.addChildNode = function (parentNode, unit) {
        parentNode.children.push({
            data: unit,
            label: unit.name,
            icon: unit.icon,
            children: []
        });
    };
    SyllabusUtils.prototype.findTreeNode = function (tree, unitId) {
        for (var i = 0; i < tree.length; i++) {
            var node = tree[i];
            var found = this.findTreeSubNode(node, unitId);
            if (found)
                return found;
        }
        return null;
    };
    SyllabusUtils.prototype.findTreeSubNode = function (node, unitId) {
        if (node.data.id == unitId)
            return node;
        for (var i = 0; i < node.children.length; i++) {
            var childNode = node.children[i];
            var found = this.findTreeSubNode(childNode, unitId);
            if (found)
                return found;
        }
        return null;
    };
    return SyllabusUtils;
}());
exports.SyllabusUtils = SyllabusUtils;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC9zaGFyZWQvaGVscGVycy9zeWxsYWJ1cy51dGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUVBLDhCQUFnQztBQUdoQztJQUVFO0lBQ0EsQ0FBQztJQUVELHNDQUFjLEdBQWQsVUFBZSxLQUFtQjtRQUNoQyxPQUFPLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQ3hDLENBQUM7SUFFRCxtQ0FBVyxHQUFYLFVBQVksS0FBbUIsRUFBRSxRQUFnQjtRQUFqRCxpQkFJQztRQUhDLElBQUksUUFBUSxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLFVBQUMsSUFBSTtZQUNsQyxPQUFPLEtBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztRQUMvQyxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxtQ0FBVyxHQUFYLFVBQVksSUFBSTtRQUNkLElBQUksUUFBUSxHQUFHLEVBQUUsQ0FBQztRQUNsQixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUUsSUFBSSxDQUFDLE1BQU0sRUFBQyxDQUFDLEVBQUU7WUFDaEMsUUFBUSxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3hELE9BQU8sUUFBUSxDQUFDO0lBQ2xCLENBQUM7SUFFTyxtQ0FBVyxHQUFuQixVQUFvQixRQUFRO1FBQzFCLElBQUksUUFBUSxHQUFHLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDMUIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFFLFFBQVEsQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFDLENBQUMsRUFBRTtZQUM3QyxRQUFRLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsV0FBVyxDQUFDLFFBQVEsQ0FBQyxR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QUksS0FBSyxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBQy9DLElBQUksS0FBSztnQkFDUCxPQUFPLEtBQUssQ0FBQztTQUNoQjtRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVPLHVDQUFlLEdBQXZCLFVBQXdCLElBQUksRUFBRSxNQUFNO1FBQ2xDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLElBQUksTUFBTTtZQUN4QixPQUFPLElBQUksQ0FBQztRQUNkLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUM3QyxJQUFJLFNBQVMsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2pDLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsU0FBUyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBQ3BELElBQUksS0FBSztnQkFDUCxPQUFPLEtBQUssQ0FBQztTQUNoQjtRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUNILG9CQUFDO0FBQUQsQ0EzSkEsQUEySkMsSUFBQTtBQTNKWSxzQ0FBYSIsImZpbGUiOiJhcHAvc2hhcmVkL2hlbHBlcnMvc3lsbGFidXMudXRpbHMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPYnNlcnZhYmxlLCBTdWJqZWN0IH0gZnJvbSAncnhqcy9SeCdcbmltcG9ydCB7IENvdXJzZVVuaXQgfSBmcm9tICcuLi9tb2RlbHMvZWxlYXJuaW5nL2NvdXJzZS11bml0Lm1vZGVsJztcbmltcG9ydCAqIGFzIF8gZnJvbSAndW5kZXJzY29yZSc7XG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmV4cG9ydCBjbGFzcyBTeWxsYWJ1c1V0aWxzIHtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgfVxuXG4gIGJ1aWxkR3JvdXBUcmVlKHVuaXRzOiBDb3Vyc2VVbml0W10pIHtcbiAgICByZXR1cm4gdGhpcy5idWlsZFN1YlRyZWUobnVsbCwgdW5pdHMpO1xuICB9XG5cbiAgZ2V0U3ViR3JvdXAodW5pdHM6IENvdXJzZVVuaXRbXSwgcGFyZW50SWQ6IG51bWJlcikge1xuICAgIHZhciBzdWJVbml0cyA9IF8uZmlsdGVyKHVuaXRzLCAodW5pdCkgPT4ge1xuICAgICAgcmV0dXJuIHRoaXMuaXNTdWJVbml0KHVuaXRzLCB1bml0LCBwYXJlbnRJZCk7XG4gICAgfSk7XG4gIH1cblxuICBmbGF0dGVuVHJlZSh0cmVlKSB7XG4gICAgdmFyIG5vZGVMaXN0ID0gW107XG4gICAgZm9yICh2YXIgaSA9IDA7IGk8IHRyZWUubGVuZ3RoO2krKylcbiAgICAgIG5vZGVMaXN0ID0gbm9kZUxpc3QuY29uY2F0KHRoaXMuZmxhdHRlbk5vZGUodHJlZVtpXSkpO1xuICAgIHJldHVybiBub2RlTGlzdDtcbiAgfVxuXG4gIHByaXZhdGUgZmxhdHRlbk5vZGUodHJlZU5vZGUpIHtcbiAgICB2YXIgbm9kZUxpc3QgPSBbdHJlZU5vZGVdO1xuICAgIGZvciAodmFyIGkgPSAwOyBpPCB0cmVlTm9kZS5jaGlsZHJlbi5sZW5ndGg7aSsrKVxuICAgICAgbm9kZUxpc3QgPSBub2RlTGlzdC5jb25jYXQodGhpcy5mbGF0dGVuTm9kZSh0cmVlTm9kZS5jaGlsZHJlbltpXSkpO1xuICAgIHJldHVybiBub2RlTGlzdDtcbiAgfVxuXG4gIHByaXZhdGUgaXNTdWJVbml0KHVuaXRzOiBDb3Vyc2VVbml0W10sIHRhcmdldDogQ291cnNlVW5pdCwgcGFyZW50SWQ6IG51bWJlcikge1xuICAgIHdoaWxlICh0YXJnZXQpIHtcbiAgICAgIGlmICh0YXJnZXQuaWQgPT0gcGFyZW50SWQpXG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgaWYgKHRhcmdldC5wYXJlbnRfaWQpXG4gICAgICAgIHRhcmdldCA9IF8uZmluZCh1bml0cywgKHVuaXQpID0+IHtcbiAgICAgICAgICByZXR1cm4gdW5pdC5pZCA9PSB0YXJnZXQucGFyZW50X2lkO1xuICAgICAgICB9KTtcbiAgICAgIGVsc2VcbiAgICAgICAgdGFyZ2V0ID0gbnVsbDtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgcHJpdmF0ZSBidWlsZFN1YlRyZWUocGFyZW50VW5pdDogQ291cnNlVW5pdCwgdW5pdHM6IENvdXJzZVVuaXRbXSkge1xuICAgIHZhciBzdWJUcmVlcyA9IFtdO1xuICAgIHZhciBkaXJlY3RDaGlsZHMgPSBbXTtcbiAgICBpZiAoIXBhcmVudFVuaXQpXG4gICAgICBkaXJlY3RDaGlsZHMgPSBfLmZpbHRlcih1bml0cywgKHVuaXQpID0+IHtcbiAgICAgICAgcmV0dXJuICF1bml0LnBhcmVudF9pZDtcbiAgICAgIH0pO1xuICAgIGVsc2Uge1xuICAgICAgZGlyZWN0Q2hpbGRzID0gXy5maWx0ZXIodW5pdHMsICh1bml0KSA9PiB7XG4gICAgICAgIHJldHVybiBwYXJlbnRVbml0LmlkID09IHVuaXQucGFyZW50X2lkO1xuICAgICAgfSk7XG4gICAgfVxuICAgIF8uZWFjaChkaXJlY3RDaGlsZHMsICh1bml0KSA9PiB7XG4gICAgICB2YXIgY2hpbGRyZW4gPSB0aGlzLmJ1aWxkU3ViVHJlZSh1bml0LCB1bml0cyk7XG4gICAgICBjaGlsZHJlbiA9IF8uc29ydEJ5KGNoaWxkcmVuLCAob2JqKSA9PiB7IHJldHVybiBvYmouZGF0YS5vcmRlciB9KTtcbiAgICAgIHN1YlRyZWVzLnB1c2goXG4gICAgICAgIHtcbiAgICAgICAgICBkYXRhOiB1bml0LFxuICAgICAgICAgIGxhYmVsOiB1bml0Lm5hbWUsXG4gICAgICAgICAgaWNvbjogdW5pdC5pY29uLFxuICAgICAgICAgIGV4cGFuZGVkOiB0cnVlLFxuICAgICAgICAgIGNoaWxkcmVuOiBjaGlsZHJlblxuICAgICAgICB9KTtcbiAgICB9KTtcbiAgICBzdWJUcmVlcyA9IF8uc29ydEJ5KHN1YlRyZWVzLCAob2JqKSA9PiB7IHJldHVybiBvYmouZGF0YS5vcmRlciB9KTtcbiAgICByZXR1cm4gc3ViVHJlZXM7XG4gIH1cblxuICBwdWJsaWMgbW92ZVVwKHRyZWUsIG5vZGUpIHtcbiAgICB2YXIgc2libGluZ3MgPSBbXTtcbiAgICBpZiAoIW5vZGUucGFyZW50KSB7XG4gICAgICBzaWJsaW5ncyA9IHRyZWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIHZhciBwYXJlbnROb2RlID0gdGhpcy5maW5kVHJlZU5vZGUodHJlZSwgbm9kZS5wYXJlbnQuZGF0YS5pZCk7XG4gICAgICBzaWJsaW5ncyA9IHBhcmVudE5vZGUuY2hpbGRyZW47XG4gICAgfVxuICAgIHZhciBjdXJJbmRleCA9IF8uZmluZEluZGV4KHNpYmxpbmdzLCAob2JqKSA9PiB7cmV0dXJuIG9iai5kYXRhLmlkID09IG5vZGUuZGF0YS5pZH0pO1xuICAgIGlmIChjdXJJbmRleCA+IDApIHtcbiAgICAgIHZhciBwcmV2Tm9kZSA9IHNpYmxpbmdzW2N1ckluZGV4IC0gMV07XG4gICAgICB2YXIgcHJldkRhdGEgPSBwcmV2Tm9kZS5kYXRhO1xuICAgICAgdmFyIGN1cnJlbnREYXRhID0gbm9kZS5kYXRhO1xuICAgICAgdmFyIHRtcCA9IHByZXZEYXRhLm9yZGVyO1xuICAgICAgcHJldkRhdGEub3JkZXIgPSBjdXJyZW50RGF0YS5vcmRlcjtcbiAgICAgIGN1cnJlbnREYXRhLm9yZGVyID0gdG1wO1xuICAgICAgc2libGluZ3NbY3VySW5kZXhdID0gcHJldk5vZGU7XG4gICAgICBzaWJsaW5nc1tjdXJJbmRleCAtIDFdID0gbm9kZTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgbW92ZURvd24odHJlZSwgbm9kZSkge1xuICAgIHZhciBzaWJsaW5ncyA9IFtdO1xuICAgIGlmICghbm9kZS5wYXJlbnQpIHtcbiAgICAgIHNpYmxpbmdzID0gdHJlZTtcbiAgICB9IGVsc2Uge1xuICAgICAgdmFyIHBhcmVudE5vZGUgPSB0aGlzLmZpbmRUcmVlTm9kZSh0cmVlLCBub2RlLnBhcmVudC5kYXRhLmlkKTtcbiAgICAgIHNpYmxpbmdzID0gcGFyZW50Tm9kZS5jaGlsZHJlbjtcbiAgICB9XG4gICAgdmFyIGN1ckluZGV4ID0gXy5maW5kSW5kZXgoc2libGluZ3MsIChvYmopID0+IHtyZXR1cm4gb2JqLmRhdGEuaWQgPT0gbm9kZS5kYXRhLmlkfSk7XG4gICAgaWYgKGN1ckluZGV4IDwgc2libGluZ3MubGVuZ3RoIC0gMSkge1xuICAgICAgdmFyIG5leHROb2RlID0gc2libGluZ3NbY3VySW5kZXggKyAxXTtcbiAgICAgIHZhciBuZXh0RGF0YSA9IG5leHROb2RlLmRhdGE7XG4gICAgICB2YXIgY3VycmVudERhdGEgPSBub2RlLmRhdGE7XG4gICAgICB2YXIgdG1wID0gbmV4dERhdGEub3JkZXI7XG4gICAgICBuZXh0RGF0YS5vcmRlciA9IGN1cnJlbnREYXRhLm9yZGVyO1xuICAgICAgY3VycmVudERhdGEub3JkZXIgPSB0bXA7XG4gICAgICBzaWJsaW5nc1tjdXJJbmRleF0gPSBuZXh0Tm9kZTtcbiAgICAgIHNpYmxpbmdzW2N1ckluZGV4ICsgMV0gPSBub2RlO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBhZGRSb290Tm9kZSh0cmVlLCB1bml0KSB7XG4gICAgdHJlZS5wdXNoKFxuICAgICAge1xuICAgICAgICBkYXRhOiB1bml0LFxuICAgICAgICBsYWJlbDogdW5pdC5uYW1lLFxuICAgICAgICBpY29uOiB1bml0Lmljb24sXG4gICAgICAgIGNoaWxkcmVuOiBbXVxuICAgICAgfSk7XG4gIH1cblxuXG4gIHB1YmxpYyBhZGRDaGlsZE5vZGUocGFyZW50Tm9kZSwgdW5pdCkge1xuICAgIHBhcmVudE5vZGUuY2hpbGRyZW4ucHVzaChcbiAgICAgIHtcbiAgICAgICAgZGF0YTogdW5pdCxcbiAgICAgICAgbGFiZWw6IHVuaXQubmFtZSxcbiAgICAgICAgaWNvbjogdW5pdC5pY29uLFxuICAgICAgICBjaGlsZHJlbjogW11cbiAgICAgIH0pO1xuICB9XG5cbiAgZmluZFRyZWVOb2RlKHRyZWUsIHVuaXRJZCkge1xuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdHJlZS5sZW5ndGg7IGkrKykge1xuICAgICAgdmFyIG5vZGUgPSB0cmVlW2ldO1xuICAgICAgdmFyIGZvdW5kID0gdGhpcy5maW5kVHJlZVN1Yk5vZGUobm9kZSwgdW5pdElkKTtcbiAgICAgIGlmIChmb3VuZClcbiAgICAgICAgcmV0dXJuIGZvdW5kO1xuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIHByaXZhdGUgZmluZFRyZWVTdWJOb2RlKG5vZGUsIHVuaXRJZCkge1xuICAgIGlmIChub2RlLmRhdGEuaWQgPT0gdW5pdElkKVxuICAgICAgcmV0dXJuIG5vZGU7XG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBub2RlLmNoaWxkcmVuLmxlbmd0aDsgaSsrKSB7XG4gICAgICB2YXIgY2hpbGROb2RlID0gbm9kZS5jaGlsZHJlbltpXTtcbiAgICAgIHZhciBmb3VuZCA9IHRoaXMuZmluZFRyZWVTdWJOb2RlKGNoaWxkTm9kZSwgdW5pdElkKTtcbiAgICAgIGlmIChmb3VuZClcbiAgICAgICAgcmV0dXJuIGZvdW5kO1xuICAgIH1cbiAgICByZXR1cm4gbnVsbDtcbiAgfVxufVxuIl19
